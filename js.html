<script>
    function insertarContacto()
    {   
        /* Obtener los datos */
        //Esto obtiene los id del formulario en main html
        let nombre = document.getElementById('nombre').value;
        let apellidos = document.getElementById('apellidos').value;
        let correo = document.getElementById('correo').value;
        let telf = document.getElementById('telf').value;

        /* Cerrar Modal */
        bootstrap.Modal.getInstance(document.getElementById('crearContactoModal')).hide();

        /* Eliminar la tabla */
        eliminarTabla();

        /* Insertar loader */
        crearLoaderAnillo('divContactos');
        /* aquí se escribe la función que trabajará con los valores devueltos por la función obtener contactos. que recuerda que es un array */
        google.script.run
        .withSuccessHandler(contactoInsertadoCorrectamente)
        .withFailureHandler(contactoInsertadoError)
        .insertarContacto(nombre, apellidos, correo, telf);         /* insertarContactos() es la función que se programa en el archivo funciones.js */
    }

    function contactoInsertadoCorrectamente(){
        //Eliminamos los datos de los inputs
        document.getElementById('nombre').value = '';
        document.getElementById('correo').value = '';

        //Mostrar notificacion
        crearNotificacionContacto('Contacto insertado correctamente', 'CONTACTO OK')

        //Eliminar Loader
        eliminarLoader();

        //Mostrar la tabla
        crearTablaContactos();
    }

    function contactoInsertadoError(){
        crearNotificacionError('No se ha podido insertar el contacto','ERROR')
        //Eliminar Loader
        eliminarLoader();
        //Mostrar la tabla
        crearTablaContactos();
    }

    //Interactividad del Main
    function crearTablaContactos()
    {   
        /* Borrar Tabla */
        eliminarTabla();

        /* Insertar loader */
        crearLoaderAnillo('divContactos');
        /* aquí se escribe la función que trabajará con los valores devueltos por la función obtener contactos. que recuerda que es un array */
        google.script.run
        .withSuccessHandler(crearTablaContactosCorrectamente)
        .withFailureHandler(crearTablaContactosError)
        .obtenerContactos();         /* ObtenerContactos() es la función que se programa en el archivo funciones.js */
    }

    function crearTablaContactosCorrectamente(obj)
            {   


                tabla = document.createElement('table'); /* create elemen sirve para crear un elemento de tipo HTML */
                tabla.id = 'tablaContactos' /* Colocamos un id para que cuando aplanemos mostrar tabla compruebe si existe  */

                let tablaHeader = document.createElement('thead'); /* Interferir el bucle para que en la primera iteración determinemos cual es el encabezado. */
                let tablaBody = document.createElement('tbody');
                


                /* Crear tabla con bucle for */
                /* Header de la tabla */
                let primeraFila = document.createElement('tr');
                for(let i = 0; i < obj[0].length; i++){
                    let celda = document.createElement('td');
                    celda.textContent = obj[0][i];
                    primeraFila.appendChild(celda);
                    
                }
                //añadir una columna OPCIONES
                let celdaOpciones = document.createElement('td');
                celdaOpciones.textContent = 'OPCIONES';
                celdaOpciones.classList.add('text-center');
                primeraFila.appendChild(celdaOpciones);

                /* Agregar la fila al header */
                    tablaHeader.appendChild(primeraFila);
                    tabla.appendChild(tablaHeader);

                /* Body de la tabla */
                for(let i = 1; i < obj.length; i++){
                    let fila = document.createElement('tr');
                    for (let j = 0; j < obj[i].length; j++){
                        let celda = document.createElement('td');
                        celda.textContent = obj[i][j];
                        fila.appendChild(celda);
                    }
                    //Agregar los botones
                    fila.appendChild(crearCeldaBotones(i+1, obj[i])); 
                    tablaBody.appendChild(fila);
                    
                }
                /* Agregamos clases a la cabecera */
                tablaHeader.classList.add('table-dark');
                /* Agregamos el cuerpo a la tabla */
                tabla.appendChild(tablaBody);
                /* Agregamos clases a la tabla */
                tabla.classList.add('table', 'table-striped', 'border', 'border-3','border-dark');
                /* Agregamos tabla a la página */
                document.getElementById('divContactos').appendChild(tabla);

                /* Mostrar notificación de ok */
                crearNotificacionOk('Contactos obtenidos correctamente','Todo en orden');
                
                /* Eliminar loader */
                eliminarLoader();
            }
    
    function crearCeldaBotones(numFila, datosContacto){
        let celda = document.createElement('td');
        celda.classList.add('text-center');
        //Crear botón de borrar
        let botonBorrar = document.createElement('button');
        botonBorrar.onclick = () => borrarContacto(numFila);
        botonBorrar.classList.add('btn','btn-danger','m-1');

        //icono Borrar
        let iconoBorrar = document.createElement('i');
        iconoBorrar.classList.add('bi','bi-trash');
        botonBorrar.appendChild(iconoBorrar);
        
        //Crear botón modificar
        let botonModificar = document.createElement('button');
        botonModificar.onclick = () => abrirModalModificarContacto(numFila, datosContacto);
        botonModificar.classList.add('btn','btn-warning','m-1');
        
        //icono Modificar
        let iconoModificar = document.createElement('i');
        iconoModificar.classList.add('bi','bi-pencil-square');
        botonModificar.appendChild(iconoModificar);

        //Agregar los botones a la celda
        celda.appendChild(botonBorrar);
        celda.appendChild(botonModificar);

        return celda;
    }
    //abrir el modal en modo crear
    function abrirModalCrearContacto(){
        //boton crear
        let boton = document.getElementById('botonCrearModificar');
        boton.textContent = 'Crear Contacto';
        boton.classList = '';
        boton.classList.add ('btn','btn-success');

        //cambiar titulo del modal
        document.getElementById('tituloModal').textContent = 'Crear Contacto';

        //modificar el submit
        document.getElementById('formulario').onsubmit = () => insertarContacto();

        //llenar el formulario con los datos que recibimos de datosContacto
        document.getElementById('nombre').value = '';
        document.getElementById('apellidos').value = '';
        document.getElementById('correo').value = '';
        document.getElementById('telf').value = '';

        //abrir el modal
        bootstrap.Modal.getOrCreateInstance(document.getElementById('crearContactoModal')).show();
    }
//Abrir el modal en modo modificar
/* Esta función modifica el modal para reutilizarlo e intercambiarlo entre un modal para crear contacto y uno para modificar */
    function abrirModalModificarContacto(numFila, datosContacto){
        //boton modificar
        let boton = document.getElementById('botonCrearModificar');
        boton.textContent = 'Modificar Contacto';
        boton.classList = '';
        boton.classList.add ('btn','btn-warning');

        //cambiar titulo del modal
        document.getElementById('tituloModal').textContent = 'Modificar Contacto';

        //modificar el submit
        document.getElementById('formulario').onsubmit = () => modificarContacto(numFila);

        //llenar el formulario con los datos que recibimos de datosContacto
        document.getElementById('nombre').value = datosContacto[0];
        document.getElementById('apellidos').value = datosContacto[1];
        document.getElementById('correo').value = datosContacto[2];
        document.getElementById('telf').value = datosContacto[3];

        //abrir el modal
        bootstrap.Modal.getOrCreateInstance(document.getElementById('crearContactoModal')).show();
    }

    function modificarContacto(numFila){
        /* Cerrar el modal */
        bootstrap.Modal.getOrCreateInstance(document.getElementById('crearContactoModal')).hide();

        /* Obtener nuevos datos a partir del formulario */
        let nombre = document.getElementById('nombre').value;
        let apellidos = document.getElementById('apellidos').value;
        let correo = document.getElementById('correo').value;
        let telf = document.getElementById('telf').value;
         /* Eliminar la tabla */
        eliminarTabla();

        /* Insertar loader */
        crearLoaderAnillo('divContactos');
        /* aquí se escribe la función que trabajará con los valores devueltos por la función obtener contactos. que recuerda que es un array */
        google.script.run
        .withSuccessHandler(contactoModificadoCorrectamente)
        .withFailureHandler(contactoModificadoError)
        .modificarContacto(numFila,{nombre, apellidos, correo, telf}); 
    }

    function contactoModificadoCorrectamente(){

        crearNotificacionContacto('Contacto modificado correctamente', 'MODIFICACIÓN OK');
        eliminarLoader();
        crearTablaContactos();
        }

    function contactoModificadoError(){
        crearNotificacionError('No se ha podido modificar el contacto','ERROR');
        eliminarLoader();
        crearTablaContactos();
    }
    
    function borrarContacto(numFila){
         /* Eliminar la tabla */
        eliminarTabla();

        /* Insertar loader */
        crearLoaderAnillo('divContactos');
        /* aquí se escribe la función que trabajará con los valores devueltos por la función obtener contactos. que recuerda que es un array */
        google.script.run
        .withSuccessHandler(contactoBorradoCorrectamente)
        .withFailureHandler(contactoBorradoError)
        .borrarContacto(numFila); 
    }

    function contactoBorradoCorrectamente(){

        crearNotificacionBorrar('Contacto borrado correctamente', 'BORRADO OK');
        eliminarLoader();
        crearTablaContactos();
    }

    function contactoBorradoError(){
        crearNotificacionError('No se ha podido borrar el contacto','ERROR');
        eliminarLoader();
        crearTablaContactos();
    }

    function crearTablaContactosError(){
        /* Mostrar una notificación */
        crearNotificacionError('No se han podido leer los contactos','ERROR');
        /* Eliminar loader */

        eliminarLoader();
    }



    /* Esta función crea el loader */
    function crearLoader(elementoPadre){

        eliminarLoader();
        let loader = document.createElement('div');
        loader.id = 'loader';
        loader.appendChild(document.createElement('div'));
        loader.appendChild(document.createElement('div'));
        loader.appendChild(document.createElement('div'));
        loader.appendChild(document.createElement('div')); /* Se crean 4 divs por que asi lo necesita el loader para funcionar con el css */
        return document.getElementById(elementoPadre).appendChild(loader);
    }

    function crearLoaderPuntos(elementoPadre){
        let loader = crearLoader(elementoPadre);
        loader.classList.add('lds-ellipsis'); /* Se le añade la clase al div principal */
    }

    function crearLoaderAnillo(elementoPadre){
        let loader = crearLoader(elementoPadre);
        loader.classList.add('lds-ring'); /* Se le añade la clase al div principal */
    }
    /* Esta funcion elimina el loader cuando termine la carga de la tabla */
    function eliminarLoader(){
        let loader = document.getElementById('loader');
        if(loader) loader.remove();
    }
    

    function eliminarTabla(){
        let tabla = document.getElementById('tablaContactos'); /* Tratamos de seleleccionar la tabla para comprobar si existe por que más adelante se crea una tabla con ese id */
        if (tabla) tabla.remove();
    }

    function importarContactos(){
        //Eliminar tabla contactos
        eliminarTabla();

        //Crear Loader
        crearLoaderAnillo('divContactos');

        google.script.run
        .withSuccessHandler(contactosImportadosCorrectamente)
        .withFailureHandler(contactosImportadosError)
        .importarContactos();
    }

    function contactosImportadosCorrectamente(){

        crearNotificacionContacto('Se han importado 5 contactos correctamente', 'IMPORTACION OK');
        eliminarLoader();
        crearTablaContactos();
    }

    function contactosImportadosError(){
        crearNotificacionError('No se ha podido importar los contactos','ERROR');
        eliminarLoader();
        crearTablaContactos();
        }

    
</script>


